<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="utf-8" />
    <title>–ê–ª–µ—è –º–∏—Ä—É ‚Äî –ö–≤–µ—Å—Ç —ñ–∑ QR-–ø—ñ–¥–∫–∞–∑–∫–∞–º–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- html5-qrcode (—Å–∫–∞–Ω–µ—Ä QR) -->
    <script src="https://unpkg.com/html5-qrcode@latest/html5-qrcode.min.js"></script>

    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#06b6d4',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif']
                    },
                    animation: {
                        'pulse-soft': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-soft': 'bounce 1s infinite'
                    }
                }
            }
        };
    </script>


    <style>
        /* Custom styles for QR reader and enhanced animations */
        #qr-reader {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .btn-hover:active {
            transform: translateY(0);
        }

        .badge-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .text-gradient {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ */
        .modal-enter {
            animation: modalEnter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-exit {
            animation: modalExit 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes modalExit {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }

            to {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
        }
    </style>
</head>

<body class="gradient-bg min-h-screen text-white font-sans">
    <div class="container mx-auto px-4 py-6 max-w-md">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-2 text-gradient">
                üïäÔ∏è –ê–ª–µ—è –º–∏—Ä—É
            </h1>
            <p class="text-white/90 text-sm">
                –ü—Ä–æ—Å–∫–∞–Ω—É–π QR ‚Üí –æ—Ç—Ä–∏–º–∞–π –ø—ñ–¥–∫–∞–∑–∫—É ‚Üí –∑–Ω–∞–π–¥–∏ –Ω–∞—Å—Ç—É–ø–Ω—É —Å—Ç–∞–Ω—Ü—ñ—é
            </p>
        </header>

        <!-- QR Scanner Card -->
        <div class="glass-card rounded-3xl p-6 mb-6 shadow-2xl">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                üì± <span class="ml-2">–°–∫–∞–Ω–µ—Ä QR</span>
            </h3>

            <div id="qr-reader" class="mb-4"></div>

            <div id="controls" class="flex gap-3 mb-4">
                <button id="btnStart"
                    class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 text-white py-3 px-4 rounded-2xl font-semibold btn-hover transition-all duration-300 flex items-center justify-center gap-2">
                    ‚ñ∂Ô∏è <span>–£–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–∫–∞–Ω–µ—Ä</span>
                </button>
                <button id="btnStop"
                    class="flex-1 bg-gradient-to-r from-red-500 to-pink-500 text-white py-3 px-4 rounded-2xl font-semibold btn-hover transition-all duration-300 flex items-center justify-center gap-2"
                    disabled>
                    ‚èπÔ∏è <span>–í–∏–º–∫–Ω—É—Ç–∏ —Å–∫–∞–Ω–µ—Ä</span>
                </button>
            </div>

            <div id="msg" class="text-sm text-gray-600 bg-gray-100 rounded-xl p-3 min-h-[3rem] flex items-center"></div>

            <div id="actionRow" class="hidden text-center mt-4">
                <button id="btnScanAgain"
                    class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white py-3 px-6 rounded-2xl font-semibold btn-hover transition-all duration-300 flex items-center justify-center gap-2 mx-auto">
                    üîÑ <span>–°–∫–∞–Ω—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</span>
                </button>
            </div>
        </div>

        <!-- Progress Card -->
        <div class="glass-card rounded-3xl p-6 shadow-2xl">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                üìä <span class="ml-2">–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å</span>
            </h3>

            <div id="progressText" class="text-lg font-bold text-center text-gray-700 mb-4">
                0 / 20 –ø—Ä–æ–π–¥–µ–Ω–æ
            </div>

            <div id="badges" class="grid grid-cols-10 gap-2 mb-6"></div>

            <details class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-4 mb-4">
                <summary class="cursor-pointer font-semibold text-gray-700 flex items-center gap-2">
                    ‚ÑπÔ∏è <span>–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?</span>
                </summary>
                <p class="text-sm text-gray-600 mt-3 leading-relaxed">
                    –ü—Ä–∏ –ø–µ—Ä—à–æ–º—É —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—ñ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –≤–∏–ø–∞–¥–∫–æ–≤–∏–π –º–∞—Ä—à—Ä—É—Ç.
                    –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ —É –≤–∞—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ.
                </p>
            </details>

            <div class="text-center">
                <button id="btnReset"
                    class="bg-gradient-to-r from-orange-500 to-red-500 text-white py-3 px-6 rounded-2xl font-semibold btn-hover transition-all duration-300 flex items-center justify-center gap-2 mx-auto">
                    üîÑ <span>–ü–æ—á–∞—Ç–∏ —Å–ø–æ—á–∞—Ç–∫—É</span>
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑ –ø—ñ–¥–∫–∞–∑–∫–æ—é -->
    <div id="hintModal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl max-w-lg w-full max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white p-6 flex items-center justify-between">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    üí° <span>–ü—ñ–¥–∫–∞–∑–∫–∞ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —Å—Ç–∞–Ω—Ü—ñ—ó</span>
                </h3>
                <button id="btnCloseModal" class="text-white/80 hover:text-white text-2xl font-bold transition-colors">
                    √ó
                </button>
            </div>
            <div class="p-6">
                <iframe id="hintFrame" title="–ü—ñ–¥–∫–∞–∑–∫–∞" class="w-full h-96 rounded-xl border-0 bg-white"></iframe>
                <div class="mt-6 text-center">
                    <button id="btnContinueScanning"
                        class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white py-3 px-6 rounded-2xl font-semibold btn-hover transition-all duration-300 flex items-center justify-center gap-2 mx-auto">
                        üîÑ <span>–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è =====
        const TOTAL_STATIONS = 20;
        // –ù–û–í–ê –õ–û–ì–Ü–ö–ê: –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–π (—Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π) —Ü–∏–∫–ª 1‚Üí2‚Üí...‚Üí20‚Üí(–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ 1, —Ç—ñ–ª—å–∫–∏ —è–∫ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —É –ø—ñ–¥–∫–∞–∑—Ü—ñ 20)
        // –ö–æ–∂–µ–Ω —É—á–µ–Ω—å –º–æ–∂–µ –ø–æ—á–∞—Ç–∏ –∑ –±—É–¥—å-—è–∫–æ—ó —Å—Ç–∞–Ω—Ü—ñ—ó. –ó —Ü—å–æ–≥–æ –º–æ–º–µ–Ω—Ç—É –π–æ–≥–æ –ø–æ—Ä—è–¥–æ–∫ = start, start+1, ... 20, 1, 2 ... (–ø–æ–∫–∏ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–æ –≤—Å—ñ 20 –£–ù–Ü–ö–ê–õ–¨–ù–ò–•).
        // –¢–æ–∂ –º–∏ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ª–∏—à–µ: startId, visited (–º–Ω–æ–∂–∏–Ω–∞), –ø–æ—Ç–æ—á–Ω–∏–π expectedId.
        // –ú–∞—Ä—à—Ä—É—Ç –Ω–µ —Ä–∞–Ω–¥–æ–º–Ω–∏–π ‚Äî –∑–∞–±–∏—Ä–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—é –ª–æ–≥—ñ–∫—É shuffle.

        // –ú–∞–ø–∞ —Å—Ç–∞–Ω—Ü—ñ–π ‚Üí —à–ª—è—Ö –¥–æ –ø—ñ–¥–∫–∞–∑–∫–∏ (–º–æ–∂–µ—Ç–µ –≤—ñ–¥—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—ñ–¥ —Å–≤–æ—ó —Ñ–∞–π–ª–∏)
        function hintUrlFor(id) {
            const two = String(id).padStart(2, '0');
            // –í—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –ø—Ä–∞—Ü—é—î —ñ –Ω–∞ –∫–æ—Ä–µ–Ω–µ–≤—ñ–π, —ñ –Ω–∞ GitHub Pages –ø—ñ–¥–ø–∞–ø—Ü—ñ
            return `hints/${two}.html`;
        }

        // ===== –°—Ç–∞–Ω/LocalStorage =====
        const LS_KEYS = {
            start: 'peace_alley_start_v2',   // –ø–µ—Ä—à–∞ –ø—Ä–æ—Å–∫–∞–Ω–æ–≤–∞–Ω–∞ —Å—Ç–∞–Ω—Ü—ñ—è (—Å—Ç–∞—Ä—Ç —Ü–∏–∫–ª—É)
            visited: 'peace_alley_visited_v2', // –º–∞—Å–∏–≤ –≤—ñ–¥–≤—ñ–¥–∞–Ω–∏—Ö
            expected: 'peace_alley_expected_v2' // –ø–æ—Ç–æ—á–Ω–∞ –æ—á—ñ–∫—É–≤–∞–Ω–∞ —Å—Ç–∞–Ω—Ü—ñ—è (–Ω–∞—Å—Ç—É–ø–Ω–∞, —è–∫—É —Ç—Ä–µ–±–∞ –ó–Ü–°–ö–ê–ù–£–í–ê–¢–ò)
        };

        let startId = loadStart();          // —á–∏—Å–ª–æ –∞–±–æ null
        let visited = loadVisited();        // Set
        let expectedId = loadExpected();    // —á–∏—Å–ª–æ –∞–±–æ null
        let waitingForHintForId = null;     // —â–æ–π–Ω–æ –∫–æ—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ—Å–∫–∞–Ω–æ–≤–∞–Ω–∞, –¥–ª—è —è–∫–æ—ó –ø–æ–∫–∞–∑–∞–ª–∏ –ø—ñ–¥–∫–∞–∑–∫—É

        function loadStart() {
            const raw = localStorage.getItem(LS_KEYS.start);
            return raw ? parseInt(raw, 10) : null;
        }
        function saveStart(id) { localStorage.setItem(LS_KEYS.start, String(id)); }

        function loadVisited() {
            try {
                const arr = JSON.parse(localStorage.getItem(LS_KEYS.visited));
                return new Set(Array.isArray(arr) ? arr : []);
            } catch { return new Set(); }
        }
        function saveVisited(set) { localStorage.setItem(LS_KEYS.visited, JSON.stringify([...set])); }

        function loadExpected() {
            const raw = localStorage.getItem(LS_KEYS.expected);
            return raw ? parseInt(raw, 10) : null;
        }
        function saveExpected(id) { localStorage.setItem(LS_KEYS.expected, String(id)); }

        function resetAll() {
            startId = null;
            visited = new Set();
            expectedId = null;
            waitingForHintForId = null;
            localStorage.removeItem(LS_KEYS.start);
            localStorage.removeItem(LS_KEYS.visited);
            localStorage.removeItem(LS_KEYS.expected);
            updateUI();
            stopScanner();
            initScanner();
            setMsg('üîÑ –ü—Ä–æ–≥—Ä–µ—Å —Å–∫–∏–Ω—É—Ç–æ. –ü—Ä–æ—Å–∫–∞–Ω—É–π—Ç–µ –±—É–¥—å-—è–∫—É —Å—Ç–∞–Ω—Ü—ñ—é, —â–æ–± –ø–æ—á–∞—Ç–∏ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å.', 'warn');
        }

        // ===== –ú–∞—Ä—à—Ä—É—Ç =====
        // ===== –î–æ–ø–æ–º—ñ–∂–Ω–µ –¥–ª—è –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ =====
        function nextSequential(id) {
            return id === TOTAL_STATIONS ? 1 : id + 1;
        }

        // ===== –ü–∞—Ä—Å–∏–Ω–≥ QR ‚Üí stationId =====
        function parseStationId(qrText) {
            if (!qrText || typeof qrText !== 'string') return null;
            // –®—É–∫–∞—î–º–æ –ø–µ—Ä—à–µ —á–∏—Å–ª–æ 1..20 —É —Ç–µ–∫—Å—Ç—ñ
            const m = qrText.match(/(\d{1,2})/);
            if (!m) return null;
            const id = parseInt(m[1], 10);
            if (id >= 1 && id <= TOTAL_STATIONS) return id;
            return null;
        }

        // ===== UI =====
        const badgesEl = document.getElementById('badges');
        const progressTextEl = document.getElementById('progressText');
        const hintModal = document.getElementById('hintModal');
        const hintFrame = document.getElementById('hintFrame');
        const actionRow = document.getElementById('actionRow');
        const msgEl = document.getElementById('msg');

        function setMsg(text, kind = '') {
            msgEl.textContent = text || '';
            msgEl.className = 'text-sm rounded-xl p-3 min-h-[3rem] flex items-center';

            if (kind === 'ok') {
                msgEl.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-300');
            } else if (kind === 'warn') {
                msgEl.classList.add('bg-yellow-100', 'text-yellow-700', 'border', 'border-yellow-300');
            } else if (kind === 'err') {
                msgEl.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-300');
            } else {
                msgEl.classList.add('bg-gray-100', 'text-gray-600');
            }
        }

        function showHintModal(justScannedId) {
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É –¥–ª—è –ù–ê–°–¢–£–ü–ù–û–á —Å—Ç–∞–Ω—Ü—ñ—ó (–Ω–µ –ø–æ—Ç–æ—á–Ω–æ—ó!)
            // justScannedId - —Ü–µ —Å—Ç–∞–Ω—Ü—ñ—è, —è–∫—É —â–æ–π–Ω–æ –ø—Ä–æ—Å–∫–∞–Ω—É–≤–∞–ª–∏
            // –ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —Å—Ç–∞–Ω—Ü—ñ—ó —É –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ

            if (visited.size >= TOTAL_STATIONS || !expectedId) {
                // –í—Å—ñ –≤—ñ–¥–≤—ñ–¥–∞–Ω—ñ –∞–±–æ —Ñ—ñ–Ω—ñ—à ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É
                hintFrame.src = hintUrlFor(20);
            } else {
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —Å—Ç–∞–Ω—Ü—ñ—ó (expectedId)
                hintFrame.src = hintUrlFor(expectedId);
            }
            hintModal.classList.remove('hidden');
            hintModal.children[0].classList.add('modal-enter');
            document.body.style.overflow = 'hidden';
        }

        function hideHintModal() {
            const modalContent = hintModal.children[0];
            modalContent.classList.remove('modal-enter');
            modalContent.classList.add('modal-exit');

            setTimeout(() => {
                hintModal.classList.add('hidden');
                modalContent.classList.remove('modal-exit');
                document.body.style.overflow = ''; // —Ä–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫—É
            }, 200);
        }

        function updateUI() {
            // –ë–µ–π–¥–∂—ñ
            badgesEl.innerHTML = '';
            const done = visited.size;
            for (let id = 1; id <= TOTAL_STATIONS; id++) {
                const b = document.createElement('span');
                b.className = 'aspect-square flex items-center justify-center rounded-full font-bold text-xs transition-all duration-300 cursor-default';
                b.textContent = id;

                if (visited.has(id)) {
                    b.classList.add('bg-gradient-to-br', 'from-green-500', 'to-emerald-500', 'text-white', 'shadow-lg');
                    b.title = `–°—Ç–∞–Ω—Ü—ñ—è ${id}: –ø—Ä–æ–π–¥–µ–Ω–∞ ‚úì`;
                } else if (expectedId === id) {
                    b.classList.add('bg-gradient-to-br', 'from-yellow-400', 'to-orange-500', 'text-white', 'badge-pulse', 'shadow-lg');
                    b.title = `–°—Ç–∞–Ω—Ü—ñ—è ${id}: –Ω–∞—Å—Ç—É–ø–Ω–∞ —É –≤–∞—à—ñ–π –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ`;
                } else {
                    b.classList.add('bg-white/30', 'text-gray-600', 'backdrop-blur-sm');
                    b.title = `–°—Ç–∞–Ω—Ü—ñ—è ${id}: —â–µ –ø–æ–ø–µ—Ä–µ–¥—É`;
                }
                badgesEl.appendChild(b);
            }

            // –ü—Ä–æ–≥—Ä–µ—Å
            progressTextEl.textContent = `${done} / ${TOTAL_STATIONS} –ø—Ä–æ–π–¥–µ–Ω–æ`;

            // –ö–Ω–æ–ø–∫–∞ "–°–∫–∞–Ω—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É"
            if (waitingForHintForId !== null) {
                actionRow.classList.remove('hidden');
            } else {
                actionRow.classList.add('hidden');
            }
        }

        // ===== –°–∫–∞–Ω–µ—Ä =====
        let html5QrCode = null;
        let scannerRunning = false;

        async function initScanner() {
            try {
                html5QrCode = new Html5Qrcode('qr-reader');
                btnStart.disabled = false;
                setMsg('üì∑ –ì–æ—Ç–æ–≤–æ –¥–æ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–°—Ç–∞—Ä—Ç".', 'ok');
            } catch (e) {
                setMsg('‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–∫–∞–Ω–µ—Ä–∞: ' + e, 'err');
            }
        }

        async function startScanner() {
            if (!html5QrCode || scannerRunning) return;
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            try {
                // Use rear-facing camera (environment-facing) for scanning QR codes on posters
                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanFailure
                );
                scannerRunning = true;
                btnStart.disabled = true;
                btnStop.disabled = false;
                setMsg('üìπ –°–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ. –ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥.', 'ok');
            } catch (e) {
                setMsg('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∫–∞–Ω–µ—Ä: ' + e, 'err');
            }
        }

        async function stopScanner() {
            if (!html5QrCode || !scannerRunning) return;
            try {
                await html5QrCode.stop();
                scannerRunning = false;
                btnStart.disabled = false;
                btnStop.disabled = true;
                setMsg('–°–∫–∞–Ω–µ—Ä –∑—É–ø–∏–Ω–µ–Ω–æ.');
            } catch (e) {
                setMsg('–ü–æ–º–∏–ª–∫–∞ –∑—É–ø–∏–Ω–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞: ' + e, 'err');
            }
        }

        function onScanFailure(/* error */) {
            // —ñ–≥–Ω–æ—Ä—É—î–º–æ —â–∏—Ç—Ç—è –±–µ–∑ –∫–æ–¥—É, —â–æ–± –Ω–µ –∑–∞—Å–º—ñ—á—É–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        }

        let lastScanText = null;
        let lastScanTime = 0;

        async function onScanSuccess(decodedText) {
            const now = Date.now();
            if (decodedText === lastScanText && now - lastScanTime < 1200) {
                return; // –∞–Ω—Ç–∏-–¥—É–±–ª—å
            }
            lastScanText = decodedText;
            lastScanTime = now;

            const scannedId = parseStationId(decodedText);
            if (!scannedId) {
                setMsg('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –Ω–æ–º–µ—Ä —Å—Ç–∞–Ω—Ü—ñ—ó –≤ QR.', 'err');
                return;
            }

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞—Ä—Ç—É
            if (!startId) {
                startId = scannedId;
                saveStart(startId);
                visited.add(scannedId);
                saveVisited(visited);
                expectedId = nextSequential(scannedId);
                saveExpected(expectedId);
                waitingForHintForId = scannedId;
                updateUI();
                setMsg(`–ü–æ—á–∞—Ç–æ–∫! –°—Ç–∞—Ä—Ç –∑—ñ —Å—Ç–∞–Ω—Ü—ñ—ó ${scannedId}.`, 'ok');
                stopScanner();
                showHintModal(scannedId);
                return;
            }

            // –Ø–∫—â–æ –≤–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ (–≤—ñ–¥–≤—ñ–¥–∞–Ω—ñ –≤—Å—ñ): –ø–æ–∫–∞–∑–∞—Ç–∏ 20 (—Ñ—ñ–Ω—ñ—à)
            if (visited.size >= TOTAL_STATIONS) {
                setMsg('–£—Å—ñ —Å—Ç–∞–Ω—Ü—ñ—ó –≤–∂–µ –ø—Ä–æ–π–¥–µ–Ω–æ. –ú–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏.', 'warn');
                stopScanner();
                showHintModal(20);
                waitingForHintForId = null;
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –æ—á—ñ–∫—É–≤–∞–Ω—É —Å—Ç–∞–Ω—Ü—ñ—é
            if (scannedId !== expectedId) {
                if (visited.has(scannedId)) {
                    setMsg(`–°—Ç–∞–Ω—Ü—ñ—è ${scannedId} –≤–∂–µ –±—É–ª–∞. –ó–∞—Ä–∞–∑ —à—É–∫–∞–π—Ç–µ ${expectedId}.`, 'warn');
                } else {
                    setMsg(`–¶–µ –Ω–µ —Ç–∞ —Å—Ç–∞–Ω—Ü—ñ—è. –ü–æ—Ç—Ä—ñ–±–Ω–∞ ${expectedId}.`, 'warn');
                }
                return;
            }

            // –ö–æ—Ä–µ–∫—Ç–Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∞ —Å—Ç–∞–Ω—Ü—ñ—è
            visited.add(scannedId);
            saveVisited(visited);

            // –û–Ω–æ–≤–ª—é—î–º–æ expectedId —è–∫—â–æ —â–µ –Ω–µ –≤—Å—ñ –ø—Ä–æ–π–¥–µ–Ω–æ
            if (visited.size < TOTAL_STATIONS) {
                expectedId = nextSequential(scannedId);
                // expectedId –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ —Å—Ç–∞—Ä—Ç–æ–≤–∏–º —â–µ —Ä–∞–∑, –ø–æ–∫–∏ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ñ –≤—Å—ñ, –∞–ª–µ —è–∫—â–æ —Å—Ç–∞—Ä—Ç –±—É–≤ –Ω–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ ‚Äî –ø—Ä–∞—Ü—é—î
                // –Ø–∫—â–æ –æ—á—ñ–∫—É–≤–∞–Ω–∞ –≤–∂–µ —É visited (–º–æ–∂–ª–∏–≤–æ —á–µ—Ä–µ–∑ —Ü–∏–∫–ª?) ‚Äî –ø—Ä–æ—Å—É–≤–∞—î–º–æ—Å—è –ø–æ–∫–∏ –∑–Ω–∞–π–¥–µ–º–æ –ø–µ—Ä—à—É –Ω–µ–≤—ñ–¥–≤—ñ–¥–∞–Ω—É
                while (visited.has(expectedId) && visited.size < TOTAL_STATIONS) {
                    expectedId = nextSequential(expectedId);
                }
            } else {
                expectedId = null; // –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            }
            saveExpected(expectedId === null ? '' : expectedId);

            waitingForHintForId = scannedId;
            updateUI();
            setMsg(`–ß—É–¥–æ–≤–æ! –°—Ç–∞–Ω—Ü—ñ—é ${scannedId} –¥–æ–¥–∞–Ω–æ.`, 'ok');
            stopScanner();
            showHintModal(scannedId);
        }

        // ===== –î—ñ—ó –∫–Ω–æ–ø–æ–∫ =====
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const btnScanAgain = document.getElementById('btnScanAgain');
        const btnReset = document.getElementById('btnReset');
        const btnCloseModal = document.getElementById('btnCloseModal');
        const btnContinueScanning = document.getElementById('btnContinueScanning');

        btnStart.addEventListener('click', startScanner);
        btnStop.addEventListener('click', stopScanner);

        btnScanAgain.addEventListener('click', () => {
            waitingForHintForId = null;
            updateUI();
            startScanner();
        });

        btnCloseModal.addEventListener('click', () => {
            hideHintModal();
            waitingForHintForId = null;
            updateUI();
        });

        btnContinueScanning.addEventListener('click', () => {
            hideHintModal();
            waitingForHintForId = null;
            updateUI();
            startScanner();
        });

        // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ —Ñ–æ–Ω
        hintModal.addEventListener('click', (e) => {
            if (e.target === hintModal) {
                hideHintModal();
                waitingForHintForId = null;
                updateUI();
            }
        });

        btnReset.addEventListener('click', () => {
            if (confirm('–°–∫–∏–Ω—É—Ç–∏ –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å —ñ –ø–æ—á–∞—Ç–∏ –Ω–æ–≤—É –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –∑—ñ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –±—É–¥—å-—è–∫–æ—ó —Å—Ç–∞–Ω—Ü—ñ—ó?')) {
                hideHintModal();
                resetAll();
            }
        });

        // ===== –°—Ç–∞—Ä—Ç =====
        updateUI();
        initScanner();
        // –Ø–∫—â–æ –¥–∞–Ω—ñ –≤–∂–µ –±—É–ª–∏ (–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è —Å–µ–∞–Ω—Å—É) ‚Äî –ø–µ—Ä–µ–∫–æ–Ω–∞—î–º–æ—Å—è, —â–æ expectedId –≤–∞–ª—ñ–¥–Ω–∏–π.
        if (startId && !expectedId && visited.size < TOTAL_STATIONS) {
            // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω—É —è–∫ –ø–µ—Ä—à—É –Ω–µ –≤—ñ–¥–≤—ñ–¥–∞–Ω—É –≤—ñ–¥ startId –ø–æ –∫–æ–ª—É
            let probe = nextSequential(startId);
            while (visited.has(probe) && visited.size < TOTAL_STATIONS) {
                probe = nextSequential(probe);
            }
            expectedId = visited.size >= TOTAL_STATIONS ? null : probe;
            saveExpected(expectedId === null ? '' : expectedId);
            updateUI();
        }

        // –ë–µ–∑–ø–µ–∫–∞: –∑–≤—ñ–ª—å–Ω–∏—Ç–∏ –∫–∞–º–µ—Ä—É –ø—Ä–∏ –≤–∏—Ö–æ–¥—ñ/–ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        window.addEventListener('beforeunload', () => { if (scannerRunning) html5QrCode.stop(); });
    </script>

    <noscript>
        <p><strong>–î–ª—è —Ä–æ–±–æ—Ç–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω JavaScript.</strong> –£–≤—ñ–º–∫–Ω—ñ—Ç—å –π–æ–≥–æ —É –±—Ä–∞—É–∑–µ—Ä—ñ.</p>
    </noscript>
</body>

</html>