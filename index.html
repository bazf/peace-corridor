<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="utf-8" />
    <title>–ê–ª–µ—è –º–∏—Ä—É ‚Äî –ö–≤–µ—Å—Ç —ñ–∑ QR-–ø—ñ–¥–∫–∞–∑–∫–∞–º–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Pico.css (–∞–∫—É—Ä–∞—Ç–Ω–∞ —Å—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –±–µ–∑ –∑–±—ñ—Ä–∫–∏) -->
    <link rel="stylesheet" href <div class="container">
    <header>
        <h1>üïäÔ∏è –ê–ª–µ—è –º–∏—Ä—É</h1>
        <p class="subtitle">–ü—Ä–æ—Å–∫–∞–Ω—É–π QR ‚Üí –æ—Ç—Ä–∏–º–∞–π –ø—ñ–¥–∫–∞–∑–∫—É ‚Üí –∑–Ω–∞–π–¥–∏ –Ω–∞—Å—Ç—É–ø–Ω—É —Å—Ç–∞–Ω—Ü—ñ—é</p>
    </header>s://unpkg.com/@picocss/pico@latest/css/pico.min.css">

    <!-- html5-qrcode (—Å–∫–∞–Ω–µ—Ä QR) -->
    <script src="https://unpkg.com/html5-qrcode@latest/html5-qrcode.min.js"></script>

    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --success: #51cf66;
            --warning: #ffd43b;
            --info: #74c0fc;
            --purple: #9775fa;
            --pink: #f783ac;
            --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--background);
            color: white;
            margin: 0;
            padding: 1rem;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        header h1 {
            font-size: 2.5rem;
            margin: 0;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #333;
        }

        .card h3 {
            margin: 0 0 1rem 0;
            color: #4a5568;
            font-size: 1.2rem;
        }

        #qr-reader {
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
        }

        #controls {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        button {
            border: none;
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 48px;
            flex: 1;
            min-width: 120px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--pink));
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, var(--secondary), var(--info));
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #38d9a9);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
        }

        #actionRow {
            display: none;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        #hintPanel {
            display: none;
            margin-top: 1rem;
        }

        #hintFrame {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 15px;
            background: #f8fafc;
        }

        .badges {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .badge {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: default;
        }

        .badge.ok {
            background: linear-gradient(45deg, var(--success), #38d9a9);
            color: white;
            box-shadow: 0 4px 12px rgba(81, 207, 102, 0.3);
        }

        .badge.next {
            background: linear-gradient(45deg, var(--warning), #ffa94d);
            color: #d76e00;
            border-color: #ffa94d;
            animation: pulse 2s infinite;
        }

        .badge.muted {
            background: rgba(255, 255, 255, 0.3);
            color: #666;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        #msg {
            margin: 0.75rem 0 0 0;
            min-height: 1.5rem;
            padding: 0.5rem;
            border-radius: 10px;
            font-weight: 500;
        }

        .msg-ok {
            background: rgba(81, 207, 102, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .msg-warn {
            background: rgba(255, 212, 59, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .msg-err {
            background: rgba(255, 107, 107, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .muted-text {
            color: #64748b;
        }

        #progressText {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
            text-align: center;
            margin-bottom: 1rem;
        }

        details {
            margin: 1rem 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 0.5rem;
        }

        summary {
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
        }

        .reset-section {
            margin-top: 1.5rem;
            text-align: center;
        }

        @media (max-width: 600px) {
            .container {
                padding: 0;
            }

            header h1 {
                font-size: 2rem;
            }

            button {
                padding: 0.875rem 1rem;
                font-size: 0.85rem;
            }

            .badges {
                grid-template-columns: repeat(auto-fit, minmax(35px, 1fr));
                gap: 0.4rem;
            }
        }
    </style>
</head>

<body>
    <main class="container">
        <header>
            <h1>–ê–ª–µ—è –º–∏—Ä—É</h1>
            <p class="subtle">–ü—Ä–æ—Å–∫–∞–Ω—É–π QR –ø—ñ–¥ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º ‚Üí –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äú–û—Ç—Ä–∏–º–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É‚Äù ‚Üí —Ä—É—à–∞–π –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –∑—É–ø–∏–Ω–∫–∏. –£
                –∫–æ–∂–Ω–æ–≥–æ ‚Äî —Å–≤—ñ–π –º–∞—Ä—à—Ä—É—Ç.</p>
        </header>

        <div>
            <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –°–∫–∞–Ω–µ—Ä + –∫–µ—Ä—É–≤–∞–Ω–Ω—è -->
            <section class="card">
                <h3>üì± –°–∫–∞–Ω–µ—Ä QR</h3>
                <div id="qr-reader"></div>

                <div id="controls">
                    <button id="btnStart" class="btn-primary">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
                    <button id="btnStop" class="btn-secondary" disabled>‚èπÔ∏è –°—Ç–æ–ø</button>
                </div>

                <div id="msg" class="muted-text"></div>

                <div id="actionRow">
                    <button id="btnShowHint" class="btn-success">üí° –û—Ç—Ä–∏–º–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É</button>
                    <button id="btnScanAgain" class="btn-secondary">üîÑ –°–∫–∞–Ω—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
                </div>

                <div id="hintPanel" class="card">
                    <strong>üí° –ü—ñ–¥–∫–∞–∑–∫–∞</strong>
                    <iframe id="hintFrame" title="–ü—ñ–¥–∫–∞–∑–∫–∞"></iframe>
                </div>
            </section>

            <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –ü—Ä–æ–≥—Ä–µ—Å/–ú–∞—Ä—à—Ä—É—Ç -->
            <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –ü—Ä–æ–≥—Ä–µ—Å/–ú–∞—Ä—à—Ä—É—Ç -->
            <section class="card">
                <h3>üìä –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å</h3>
                <div id="progressText">0 / 20 –ø—Ä–æ–π–¥–µ–Ω–æ</div>
                <div id="badges" class="badges"></div>

                <details>
                    <summary>‚ÑπÔ∏è –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?</summary>
                    <p class="small">
                        –ü—Ä–∏ –ø–µ—Ä—à–æ–º—É —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—ñ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –≤–∏–ø–∞–¥–∫–æ–≤–∏–π –º–∞—Ä—à—Ä—É—Ç.
                        –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ —É –≤–∞—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ.
                    </p>
                </details>

                <div class="reset-section">
                    <button id="btnReset" class="btn-outline">üîÑ –ü–æ—á–∞—Ç–∏ —Å–ø–æ—á–∞—Ç–∫—É</button>
                </div>
            </section>
        </div>
        </div>

        <script>
            // ===== –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è =====
            const TOTAL_STATIONS = 20;

            // –ú–∞–ø–∞ —Å—Ç–∞–Ω—Ü—ñ–π ‚Üí —à–ª—è—Ö –¥–æ –ø—ñ–¥–∫–∞–∑–∫–∏ (–º–æ–∂–µ—Ç–µ –≤—ñ–¥—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—ñ–¥ —Å–≤–æ—ó —Ñ–∞–π–ª–∏)
            function hintUrlFor(id) {
                const two = String(id).padStart(2, '0');
                // –í—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –ø—Ä–∞—Ü—é—î —ñ –Ω–∞ –∫–æ—Ä–µ–Ω–µ–≤—ñ–π, —ñ –Ω–∞ GitHub Pages –ø—ñ–¥–ø–∞–ø—Ü—ñ
                return `hints/${two}.html`;
            }

            // ===== –°—Ç–∞–Ω/LocalStorage =====
            const LS_KEYS = {
                route: 'peace_alley_route_v1',
                visited: 'peace_alley_visited_v1',
                index: 'peace_alley_index_v1'
            };

            let route = loadRoute();            // –º–∞—Å–∏–≤ ID (–ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∞ 1..20)
            let visited = loadVisited();        // –º–Ω–æ–∂–∏–Ω–∞ (Set) –≤—ñ–¥–≤—ñ–¥–∞–Ω–∏—Ö
            let currentIndex = loadIndex();     // –æ—á—ñ–∫—É–≤–∞–Ω–∏–π —ñ–Ω–¥–µ–∫—Å —É route (0..20)
            let waitingForHintForId = null;     // —è–∫–∏–π id –º–∏ —â–æ–π–Ω–æ –∫–æ—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ—Å–∫–∞–Ω—É–≤–∞–ª–∏

            function loadRoute() {
                try { return JSON.parse(localStorage.getItem(LS_KEYS.route)) || null; } catch { return null; }
            }
            function saveRoute(arr) { localStorage.setItem(LS_KEYS.route, JSON.stringify(arr)); }

            function loadVisited() {
                try {
                    const a = JSON.parse(localStorage.getItem(LS_KEYS.visited));
                    return new Set(Array.isArray(a) ? a : []);
                } catch { return new Set(); }
            }
            function saveVisited(set) { localStorage.setItem(LS_KEYS.visited, JSON.stringify([...set])); }

            function loadIndex() {
                const raw = localStorage.getItem(LS_KEYS.index);
                return raw === null ? 0 : parseInt(raw, 10);
            }
            function saveIndex(i) { localStorage.setItem(LS_KEYS.index, String(i)); }

            function resetAll() {
                route = null;
                visited = new Set();
                currentIndex = 0;
                waitingForHintForId = null;
                localStorage.removeItem(LS_KEYS.route);
                localStorage.removeItem(LS_KEYS.visited);
                localStorage.removeItem(LS_KEYS.index);
                updateUI();
                stopScanner();
                initScanner(); // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Å—Ç–∞–Ω—É
                setMsg('üîÑ –ü—Ä–æ–≥—Ä–µ—Å —Å–∫–∏–Ω—É—Ç–æ. –ü–æ—á–Ω—ñ—Ç—å –∑—ñ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –±—É–¥—å-—è–∫–æ—ó —Å—Ç–∞–Ω—Ü—ñ—ó.', 'warn');
            }

            // ===== –ú–∞—Ä—à—Ä—É—Ç =====
            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function generateRouteWithStart(startId) {
                const base = Array.from({ length: TOTAL_STATIONS }, (_, i) => i + 1);
                shuffle(base);
                // –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Ç–∞–∫, —â–æ–± startId –±—É–≤ –ø–µ—Ä—à–∏–º
                const idx = base.indexOf(startId);
                if (idx > 0) {
                    const head = base.slice(idx);
                    const tail = base.slice(0, idx);
                    return [...head, ...tail];
                }
                return base;
            }

            // ===== –ü–∞—Ä—Å–∏–Ω–≥ QR ‚Üí stationId =====
            function parseStationId(qrText) {
                if (!qrText || typeof qrText !== 'string') return null;
                // –®—É–∫–∞—î–º–æ –ø–µ—Ä—à–µ —á–∏—Å–ª–æ 1..20 —É —Ç–µ–∫—Å—Ç—ñ
                const m = qrText.match(/(\d{1,2})/);
                if (!m) return null;
                const id = parseInt(m[1], 10);
                if (id >= 1 && id <= TOTAL_STATIONS) return id;
                return null;
            }

            // ===== UI =====
            const badgesEl = document.getElementById('badges');
            const progressTextEl = document.getElementById('progressText');
            const hintPanel = document.getElementById('hintPanel');
            const hintFrame = document.getElementById('hintFrame');
            const actionRow = document.getElementById('actionRow');
            const msgEl = document.getElementById('msg');

            function setMsg(text, kind = '') {
                msgEl.textContent = text || '';
                msgEl.className = '';
                if (kind === 'ok') msgEl.classList.add('msg-ok');
                else if (kind === 'warn') msgEl.classList.add('msg-warn');
                else if (kind === 'err') msgEl.classList.add('msg-err');
                else msgEl.classList.add('muted-text');
            }

            function updateUI() {
                // –ë–µ–π–¥–∂—ñ
                badgesEl.innerHTML = '';
                const done = visited.size;
                for (let id = 1; id <= TOTAL_STATIONS; id++) {
                    const b = document.createElement('span');
                    b.className = 'badge';
                    b.textContent = id; // –£ –ü–õ–ê–ö–ê–¢–Ü–í –ù–û–ú–ï–†–Ü–í –ù–ï–ú–ê–Ñ; —Ü–µ –ª–∏—à–µ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Ç—Ä–µ–∫—ñ–Ω–≥
                    if (visited.has(id)) {
                        b.classList.add('ok'); b.title = `–°—Ç–∞–Ω—Ü—ñ—è ${id}: –ø—Ä–æ–π–¥–µ–Ω–∞ ‚úì`;
                    } else if (route && currentIndex < route.length && id === route[currentIndex]) {
                        b.classList.add('next'); b.title = `–°—Ç–∞–Ω—Ü—ñ—è ${id}: –Ω–∞—Å—Ç—É–ø–Ω–∞ —É –≤–∞—à–æ–º—É –º–∞—Ä—à—Ä—É—Ç—ñ`;
                    } else {
                        b.classList.add('muted'); b.title = `–°—Ç–∞–Ω—Ü—ñ—è ${id}: —â–µ –ø–æ–ø–µ—Ä–µ–¥—É`;
                    }
                    badgesEl.appendChild(b);
                }

                // –ü—Ä–æ–≥—Ä–µ—Å
                progressTextEl.textContent = `${done} / ${TOTAL_STATIONS} –ø—Ä–æ–π–¥–µ–Ω–æ`;

                // –ö–Ω–æ–ø–∫–∏/–ø–∞–Ω–µ–ª—å –ø—ñ–¥–∫–∞–∑–∫–∏
                if (waitingForHintForId !== null) {
                    actionRow.style.display = '';
                } else {
                    actionRow.style.display = 'none';
                }
            }

            // ===== –°–∫–∞–Ω–µ—Ä =====
            let html5QrCode = null;
            let scannerRunning = false;

            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');
            const btnShowHint = document.getElementById('btnShowHint');
            const btnScanAgain = document.getElementById('btnScanAgain');
            const btnReset = document.getElementById('btnReset');

            async function initScanner() {
                try {
                    html5QrCode = new Html5Qrcode('qr-reader');
                    btnStart.disabled = false;
                    setMsg('üì∑ –ì–æ—Ç–æ–≤–æ –¥–æ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–°—Ç–∞—Ä—Ç".', 'ok');
                } catch (e) {
                    setMsg('‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–∫–∞–Ω–µ—Ä–∞: ' + e, 'err');
                }
            }

            async function startScanner() {
                if (!html5QrCode || scannerRunning) return;
                const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
                try {
                    // Use front-facing camera (user-facing)
                    await html5QrCode.start(
                        { facingMode: "user" },
                        config,
                        onScanSuccess,
                        onScanFailure
                    );
                    scannerRunning = true;
                    btnStart.disabled = true;
                    btnStop.disabled = false;
                    setMsg('üìπ –°–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ. –ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥.', 'ok');
                } catch (e) {
                    setMsg('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∫–∞–Ω–µ—Ä: ' + e, 'err');
                }
            }

            async function stopScanner() {
                if (!html5QrCode || !scannerRunning) return;
                try {
                    await html5QrCode.stop();
                    scannerRunning = false;
                    btnStart.disabled = false;
                    btnStop.disabled = true;
                    setMsg('–°–∫–∞–Ω–µ—Ä –∑—É–ø–∏–Ω–µ–Ω–æ.');
                } catch (e) {
                    setMsg('–ü–æ–º–∏–ª–∫–∞ –∑—É–ø–∏–Ω–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞: ' + e, 'err');
                }
            }

            function onScanFailure(/* error */) {
                // —ñ–≥–Ω–æ—Ä—É—î–º–æ —â–∏—Ç—Ç—è –±–µ–∑ –∫–æ–¥—É, —â–æ–± –Ω–µ –∑–∞—Å–º—ñ—á—É–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            }

            let lastScanText = null;
            let lastScanTime = 0;

            async function onScanSuccess(decodedText) {
                const now = Date.now();
                if (decodedText === lastScanText && now - lastScanTime < 1200) {
                    return; // –∞–Ω—Ç–∏-–¥—É–±–ª—å
                }
                lastScanText = decodedText;
                lastScanTime = now;

                const stationId = parseStationId(decodedText);
                if (!stationId) {
                    setMsg('–¶–µ –Ω–µ —Å—Ö–æ–∂–µ –Ω–∞ –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –∫–æ–¥ —Å—Ç–∞–Ω—Ü—ñ—ó (–æ—á—ñ–∫—É—î—Ç—å—Å—è —á–∏—Å–ª–æ 1..20).', 'err');
                    return;
                }

                // –Ø–∫—â–æ –º–∞—Ä—à—Ä—É—Ç—É —â–µ –Ω–µ–º–∞—î ‚Äî –±—É–¥—É—î–º–æ –∑ —Ü—ñ—î—é —Å—Ç–∞–Ω—Ü—ñ—î—é —è–∫ —Å—Ç–∞—Ä—Ç–æ–º.
                if (!route) {
                    route = generateRouteWithStart(stationId);
                    currentIndex = 0;
                    saveRoute(route);
                    saveIndex(currentIndex);
                }

                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –æ—á—ñ–∫—É–≤–∞–Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∞ –∑—É–ø–∏–Ω–∫–∞
                const expectedId = route[currentIndex] ?? null;
                if (stationId !== expectedId) {
                    // –≤–∂–µ –≤—ñ–¥–º—ñ—á–µ–Ω–∞? (—â–æ–± –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±—É–ª–æ –¥—Ä—É–∂–Ω—î)
                    if (visited.has(stationId)) {
                        setMsg(`–°—Ç–∞–Ω—Ü—ñ—è ${stationId} –≤–∂–µ –ø—Ä–æ–π–¥–µ–Ω–∞. –ó–Ω–∞–π–¥—ñ—Ç—å –≤–∞—à—É –ø–æ—Ç–æ—á–Ω—É: —Å—Ç–∞–Ω—Ü—ñ—é ${expectedId}.`, 'warn');
                    } else {
                        setMsg(`–¶–µ –Ω–µ –≤–∞—à–∞ –Ω–∞—Å—Ç—É–ø–Ω–∞ —Å—Ç–∞–Ω—Ü—ñ—è. –ó–∞—Ä–∞–∑ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Å—Ç–∞–Ω—Ü—ñ—è ${expectedId}.`, 'warn');
                    }
                    waitingForHintForId = null;
                    updateUI();
                    return;
                }

                // –í–∞–ª—ñ–¥–Ω–æ: –ø–æ–∑–Ω–∞—á–∞—î–º–æ –≤—ñ–¥–≤—ñ–¥–∞–Ω–æ—é –π –≥–æ—Ç—É—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó
                visited.add(stationId);
                saveVisited(visited);
                currentIndex = Math.min(currentIndex + 1, route.length);
                saveIndex(currentIndex);

                waitingForHintForId = stationId; // —â–æ–π–Ω–æ —Å–∫–∞–Ω–æ–≤–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞
                updateUI();
                setMsg(`–ß—É–¥–æ–≤–æ! –°—Ç–∞–Ω—Ü—ñ—è ${stationId} –∑–∞—Ä–∞—Ö–æ–≤–∞–Ω–∞. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ‚Äú–û—Ç—Ä–∏–º–∞—Ç–∏ –ø—ñ–¥–∫–∞–∑–∫—É‚Äù.`, 'ok');

                // –ó—É–ø–∏–Ω—è—î–º–æ —Å–∫–∞–Ω–µ—Ä, —â–æ–± –Ω–µ –ª–æ–≤–∏—Ç–∏ –ø–æ–≤—Ç–æ—Ä–∏, –ø–æ–∫–∏ –ø–æ–∫–∞–∑—É—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É
                stopScanner();
            }

            // ===== –î—ñ—ó –∫–Ω–æ–ø–æ–∫ =====
            btnStart.addEventListener('click', startScanner);
            btnStop.addEventListener('click', stopScanner);

            btnShowHint.addEventListener('click', () => {
                if (waitingForHintForId === null) return;

                // –û–±—á–∏—Å–ª—é—î–º–æ –ù–ê–°–¢–£–ü–ù–£ —Å—Ç–∞–Ω—Ü—ñ—é —É –º–∞—Ä—à—Ä—É—Ç—ñ
                const nextId = route[currentIndex] ?? null;

                if (!nextId) {
                    // –º–∞—Ä—à—Ä—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                    hintFrame.srcdoc = `
          <main style="font-family:system-ui,sans-serif;padding:1rem 1.25rem;">
            <h2>–§—ñ–Ω—ñ—à!</h2>
            <p>–í–∏ –ø—Ä–æ–π—à–ª–∏ –≤—Å—ñ —Å—Ç–∞–Ω—Ü—ñ—ó –ê–ª–µ—ó –º–∏—Ä—É. –ü–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –≤—á–∏—Ç–µ–ª—è –∑–∞ –≤—ñ–¥–∑–Ω–∞–∫–æ—é –∞–±–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∑–∞–≤–¥–∞–Ω–Ω—è–º.</p>
          </main>`;
                } else {
                    hintFrame.src = hintUrlFor(nextId);
                }

                hintPanel.style.display = '';
                actionRow.style.display = '';
            });

            btnScanAgain.addEventListener('click', () => {
                hintPanel.style.display = 'none';
                waitingForHintForId = null;
                updateUI();
                startScanner();
            });

            btnReset.addEventListener('click', () => {
                if (confirm('–°–∫–∏–Ω—É—Ç–∏ –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å —ñ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –º–∞—Ä—à—Ä—É—Ç –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—ñ?')) {
                    resetAll();
                }
            });

            // ===== –°—Ç–∞—Ä—Ç =====
            updateUI();
            initScanner();

            // –ë–µ–∑–ø–µ–∫–∞: –∑–≤—ñ–ª—å–Ω–∏—Ç–∏ –∫–∞–º–µ—Ä—É –ø—Ä–∏ –≤–∏—Ö–æ–¥—ñ/–ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
            window.addEventListener('beforeunload', () => { if (scannerRunning) html5QrCode.stop(); });
        </script>

        <noscript>
            <p><strong>–î–ª—è —Ä–æ–±–æ—Ç–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω JavaScript.</strong> –£–≤—ñ–º–∫–Ω—ñ—Ç—å –π–æ–≥–æ —É –±—Ä–∞—É–∑–µ—Ä—ñ.</p>
        </noscript>
</body>

</html>